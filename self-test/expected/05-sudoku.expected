
# Build
jenga build -a
A: echo 9.8.4 > version
A: echo ~/.ghcup/bin/ghc-$(cat version) > ghc-path
A: echo exec $(cat ghc-path) '"$@"' > ghc.exe
A: chmod +x ghc.exe
A: ./ghc.exe -c Sudoku.hs -XLambdaCase
A: ./ghc.exe -c main.hs
A: ./ghc.exe main.o Sudoku.o -package containers -o solver.exe
ran 7 commands
checked 6 rules

# Solve a puzzle
jenga -q exec solver.exe puzzle
...3.9..5
...475...
......4..
89.......
.7..5..89
56....3.4
..7..492.
....9.6.8
2...31.4.

428369715
913475862
756812493
892743156
374156289
561928374
637584921
145297638
289631547

1

# Modify haskell code (careful with hard-link)
cat Sudoku.hs > x
echo xxx >> x
mv x Sudoku.hs

# Try build; expect ghc error
# We used to have a bug where the compile error was somtimes reported twice for -j2 and higher.
# Use of -j3 makes this test slightly non-deterministic regarding the placement of "ran 1 command"
jenga.exe build --cache=. --rel -j1
(stderr) 
(stderr) Sudoku.hs:161:1: error: [GHC-25277]
(stderr)     Parse error: module header, import declaration
(stderr)     or top-level declaration expected.
(stderr)     |
(stderr) 161 | xxx
(stderr)     | ^^^
(exit-code) 1
ran 1 command
Build failed for 1 reason:
(1) action failed for rule targeting: Sudoku.hi Sudoku.o

# On rebuild we correctly get just a single report
jenga.exe build --cache=. --rel -j1
(stderr) 
(stderr) Sudoku.hs:161:1: error: [GHC-25277]
(stderr)     Parse error: module header, import declaration
(stderr)     or top-level declaration expected.
(stderr)     |
(stderr) 161 | xxx
(stderr)     | ^^^
(exit-code) 1
Build failed for 1 reason:
(1) action failed for rule targeting: Sudoku.hi Sudoku.o
